pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
 game = {}
 start_game()
end

function _update()
 game.update()
end

function _draw()
 game.draw() 
end

function start_game()
  #include profile.lua
  #include stats.lua
  #include outcomes.lua
  #include activities.lua
  #include todo_list.lua
  #include dice.lua
  #include instructions.lua
  #include controller.lua
  #include music_player.lua
  #include boss_text.lua
  #include final_text.lua
  dice_select_phase = true
  activity_select_phase = false
  activity_play_phase = false
  activity_text_flag = false
  boss_phase_eng = false
  boss_phase_sua = false
  boss_phase_int = false
  boss_text_flag = false
  final_text_flag = false

  play_music_flag = false

  foobar = 0

  tbx_init()
  game.update = start_game_update
  game.draw = start_game_draw
end

function start_game_update()
  controller:update()
  instructions:update()
  tbx_update()
  music_player:update()
  -- if (btnp (4)) textbox(sample_text,nil,nil,12)
end

function start_game_draw()
  cls(13)
  profile:draw()
  stats:draw()
  todo_list:draw()
  for die in all(dice) do
    if die.is_selected then pal(9,7) end
    rectfill(die.x0,die.y0,calculate_x1(die.x0, die.width),calculate_y1(die.y0,die.width),9)
    print(die.score,die.x0,die.y0,0)
    pal()
  end
  if #dice == 0 and activity_play_phase then
    print(instructions.text, 2, 128 - 6, 11)
  else
    print(instructions.text, 2, 128 - 6, 7)
  end
  print(foobar, 0, 0, 7)

  if (#tbx_lines>0) tbx_draw()
end

function calculate_x1(x0, width)
  return x0 + width - 1
end

function calculate_y1(y0, height)
  return y0 + height - 1
end

function remove_element(e,t)
  local new_table = {}
  for i=1,#t,1 do
    if not (e == t[i]) then
      add(new_table,t[i])
    end
  end

  return new_table
end

function copy_table(table)
  new_table = {}
  for k,v in pairs(table) do
    new_table[k] = v
  end

  return new_table
end

-- text wrapping

function tbx_init()
tbx_counter=1
tbx_width=29 --characters not pixels -- shen
tbx_lines={}
tbx_cur_line=1
tbx_com_line=0
tbx_text=nil
tbx_x=nil
tbx_y=nil
end


function tbx_update()
 if tbx_text!=nil then 
 local first=nil
 local last=nil
 local rows=flr(#tbx_text/tbx_width)+2
 
 --split text into lines
 for i=1,rows do
  first =first or 1+i*tbx_width-tbx_width
  last = last or i*tbx_width
   
  --cut off incomplete words
  if sub(tbx_text,last+1,last+1)!="" or sub(tbx_text,last,last)!=" " and sub(tbx_text,last+1,last+1)!=" " then
   for j=1,tbx_width/3 do
    if sub(tbx_text,last-j,last-j)==" " and i<rows then
     last=last-j
     break
    end
   end
  end
  
  --create line
  --if first char is a space, remove the space
  if sub(tbx_text,first,first)==" " then
   tbx_lines[i]=sub(tbx_text,first+1,last)
  else
   tbx_lines[i]=sub(tbx_text,first,last)
  end
   first=last
   last=last+tbx_width
 end
 
 --lines are now made
 
 
 --change lines after printing
 if tbx_counter%tbx_width==0 and tbx_cur_line<#tbx_lines then
  tbx_com_line+=1
  tbx_cur_line+=1
  tbx_counter=1  
 end
 --update text counter
 tbx_counter+=1
 if (sub(tbx_text,tbx_counter,tbx_counter)=="") tbx_counter+=1
 end
end


function tbx_draw()
 if #tbx_lines>0 then
  --print current line one char at a time
  print(sub(tbx_lines[tbx_cur_line],1,tbx_counter),tbx_x,tbx_y+tbx_cur_line*6-6,tbx_col)

 
  --print complete lines
  for i=0,tbx_com_line do
   if i>0 then
    print(tbx_lines[i],tbx_x,tbx_y+i*6-6,tbx_col)
   end
  end
 end 
end


function textbox(text,x,y,col)
 tbx_init()
 tbx_x=x or 6 --shen
 tbx_y=y or 36 --shen
 tbx_col=col or 7
 tbx_text=text
end

function get_outcome(die_score, results)
  if die_score == 1 or die_score == 2 then
    return results.low
  elseif die_score == 3 or die_score == 4 then
    return results.med
  elseif die_score == 5 or die_score == 6 then
    return results.high
  end
end

function work_out_score(score)
  if score > 72 then
    return 72
  elseif score < 0 then
    return 0
  else
    return score
  end
end

__sfx__
490a0000055500000005550010000f5500f5550555005500055501f00005550181000e550110000f5500f500055500700005550273000f5500f55505550055000555023200055502f6000f5550a5550555005500
490a0000055500000005550010000f5500f5550555005500055501f00005550181000e550110000f5500f500055500700005550273000f5500f55505550055000555023200055502f60005550055000555005500
490a0000055500000005550010000f5500f5550555005500055501f00005550181000e550110000f5500f500055500700005550273000f5500f55505550055000e55111551055502f6000c5500a5000555005500
490a0000055500000005550010000f550020000555005500055501f00005550181000e550110000f5500f5001a3000550011550273000f5501e20005550055000755023200055502f60011550115000a50005500
490a0000055500000005550010000f5500f5550555005500055501f00005550181000e550110000f5500f500055500700005550273000f5500f55505550055000555023200055502f60005550055000555005500
490a0000085500300008550040000f5500f55508550085000855022000085501b100115501400008550125000a550050000a5502a30011550115550a550085000c5500c0000c5503260014550085001355008500
490a00000c0333f2000c0001830024613000030c023000030c033000030c0231830024613183003f200000030c0330c0000c0230c02324613183000c023000030c033000030c0230c00024613000031831300003
4d140000100430d6153731310043326133330010043000000d61500000100430000032613100433331300000100430d6153331310043326130000010043000001000000000100530000032613100430d6150d615
4d140000100430d615373130d600326130d600100430d6000d6000d600100430d61532613100433731300000100430d615373130d600326130000010043000000d61500000100430000032613100430d6150d615
490a00000c0000c0000c0000c00024600000000c000000000c000000000c0000c000246000000000000000000c0000c0000c0000c00024600000000c000000000c000000000c0000c00024600000000000000000
050a000020750207511f7511d7511d7511d7511f7002070027750277551f700207001f7501f75020750207511f7511d7511d7511d7512770027700277502775500000337001d750207001f755207002075020750
050a000020750207511d7511d7511d7510000027700247002975500000277002470027755247002475500000000002770027755207001f7552070020755000002275524700247552470029725247002772500000
050a000020750207511f7511d7511d7511d7511f7002070027750277551f70020700297402974024740247411f7412274122741227512770027700207502075500000337001d750207001b755207001f7501f750
050a000024750247512575125751247512475125751257512475124751257512575120751207512275122751000002470022750227502270020700207502075020700007001f7401f7401b7401b7401873018730
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49190000110441104518044180451c0441c0451804418045110441104518044180451c0441c04518044180450e0440e0451504415045180441804515044150450e0440e045150441504518044180450e0440e045
49190000130441304516044160451d0441d0451604416045130441304516044160451c0441c0451604416045110441104518044180451c0441c0451804418045110441104518044180451c0441c0421c0421c045
49190000110441104518044180451c0441c0451804418045110441104518044180451c0441c04518044180450e0440e04515044150451d0441d04515044150451c0441c045150441504518044180451a0441a045
4919000016044160451a0441a0451d0441d045160441604518044180451f0441f0451d0441d0451c0441c0451104411045150441504518044180451c0441c0451d0441d0451a0001a0001d0001d0001f0001f000
4919000016044160451a0441a0451f0441f0451a0441a04516044160451a0441a0451f0441f0451604416045150441504518044180451c0441c0451804418045150441504518044180451c0441c0451d0441d045
49190000130441304516044160451a0441a0451d0441d04518044180451c0441c0451f0441f04516044160451104411045150441504518044180451c0441c0421c0421c045180001d0001d0441d0421d0451d000
49190000130441304516044160451a0441a0451d0441d04518044180451c0441c04521044210451604416045150441504518044180451c0441c0451f0441f0451e0441e0451a0441a04518044180451504415045
4919000016044160451a0441a0451d0441d0451f0441f04510044100301002010010100101001518000180000c0440c0300c0200c0100c0100c0151f0001f0001e0001e0001a0001a00018000180001500015000
6b1900002153021531215222152221522215251f50024530285302853128522285252850028500235002953028530285312852228522285222852522500245302153021530215302152021520215250c50021530
6b190000215302153022530225351f5301f5351d5301d5351f5301f5301f5221f5221f5251f500235001d5301f530215302153021530215302152021520215150050000500005000050000500005000050000500
6b190000215302153021530215351f500205001f5002453028530285302853529500295302953029535295002b5302b5302b535255002953029535285302853524530245302453024520245150c5000c50024530
6b19000022530225302453024535265302653529530295352b5302b5302b5302b5352953029535285302853529530295302953029530295202952029515285002450024500245000c5000c5000c5000c5002d530
6b1900002d5202d5222d5222652526530265302653025530265302853029530295002b5202b520295302b53628530285302653026530245302453026530265302153021532215322153524500000000000021535
6b1900002253022530245302453026530265302952029520285202852024520245202152021520295001f5202152021510245202452024522245222452526500215002150021500215002450000000000002d525
6b1900002d5202d5202d52026525265202652026520245202552025520265202652028520285202b5202b52029520295222952229525245002450024520245202d5202d5222d5222d5252450000000000002d525
6b1900002d5202d5202b5202b52029520295202552025520245202452224512245152b5002b5002b5002b5002b5202b5222b5122b51524500245002450024500295002950029500295002950029500295002d500
7b1400001d05521000210001d0552105522055240552400028000277002770024700297002970029700297001b05521000210001b0551d05522055210552800024000240002470022700217001d7001b7001b700
7b1400001d05521500215001d0552105522055240552450028500285002b700297002d7002d7002d7002d7002705521500215002705524055220552105528500307002e7002d7002970027700297002470024700
7b140000190552150021500190551b0551d05520055245001f055285001b05529500220551f000295002950027000215002150027000240002200021000285001900021500240551b00022055210551b0551b000
7b1400001d05521000210001d0552105522055240552400028000277002773024730297302973229732297351b05521000210001b0551d05522055210552800024000240002473022730217301d7321b7321b735
7b1400001d05521500215001d0552105522055240552450028500285002b730297302d7302d7322d7322d7352705521500215002705524055220552105528500307302e7302d7302973027730297322473224735
7b140000190552150021500190551b0551d05520055245001f055285001b05529500220551f000295002950027000215002150027000240002200021000285001900021500240551b00022055210551b0501b055
7b1400001d00021000210001d0002100022000240002400028000277002773024730297302973229732297351b00021000210001b0001d0002200024700227002473022730217301d7321b7321b7351b7001b700
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a3140000111351d1001115529100291001b1000f155001001b1000010000100001000010000100001000010000100001000f1550010000100001000e155001000010000100001000010000100001000010000100
a3140000000001d1000e15529100291001b1000d155001001b1000010000100001000010000100001000010000100001000d1550010000100001000c155001000010000100001000010000100001000010000100
a3140000000001d1001115529100291001b1000f155001001b10000100001000010000100001000010000100001000f1000f15500100001000010016155001000010000100001000010000100001000010000100
a31400000d1551b1000d1000d155291001b1000c155001001b100001000c155001000f155111000c1500c1550a1300a1200a125001000010000100131000010000100001000c155001000f155111000c1500c100
4d1400003330010000326003330010000000000d60000000100000000032600100003330000000100000d6003330010000326000000010000000001000000000100000000032600100000d6000d6000000000000
4d140000100000d600373000d600326000d600100000d6000d6000d600100000d60032600100003730000000100000d600373000d600326000000010000000001000000000100000000032600100000d6000d600
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
491400000e0000e0001500015000180001800015000150000e0000e0001500015000180001800015000150000e0000e00015000150001d0001d00015000150001c0001c000150001500018000180001a0001a000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010300001d7501d750247502475028750287500b6000b600287502875024750247501d7501d750007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700
01050000113430000029323293130030000300003000030029343000001d3231d3130030000300003000030011300000001d30035300353003530000300003000030000300003000030000300003000030000300
9312000b0073300753007000070000000007330073300700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000000
0003000f2a7412a7412a7412a7412a7402a7402a7402a74524740247402474024740247402474024740247400774003740007400074000740007400074007700077000370003700007000a7000a7000770005700
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
01 00420644
00 01420644
00 02420644
00 03424344
01 000a0644
00 050b0644
00 020c0644
02 050d0644
01 00420844
00 01420844
00 02420844
00 03424344
01 000a0844
00 050b0844
00 020c0844
02 050d0844
01 10184644
00 11194344
00 121a4344
00 131b4344
00 141c4344
00 151d4344
00 161e4344
02 171f4344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
01 20424344
00 21424344
00 20424344
02 22664344
01 23424344
00 24424344
00 23424344
02 25264344
01 23284344
00 24294344
00 232a4344
02 25262b44
01 23284307
00 24294308
00 232a4307
02 25262b08

